DROP Schema project CASCADE;
DROP FUNCTION IF EXISTS delete_old_admin();
DROP TRIGGER IF EXISTS delete_admin
ON project.librarian;

-- Schema 

CREATE schema project;

-- Entities

CREATE TABLE project.user (
    user_name 		character varying(16) PRIMARY KEY,
    password 		character varying(16),
    first_name 		character varying(10),
    last_name 		character varying(20),
    email 			character varying(30)
);

CREATE TABLE project.address (
    add_id 		SERIAL NOT NULL PRIMARY KEY,
    street_num 	numeric(6,0),
    street_name character varying(20),
    apartment 	character varying(6),
    city 		character varying(20),
    province 	character varying(20),
    country 	character varying(20),
    postal_code character varying(6)
);

CREATE TABLE project.librarian (
    user_name 	character varying(16) REFERENCES project.user(user_name) PRIMARY KEY,
    salary 		numeric(8,2)
);

CREATE TABLE project.publisher (
    name 		character varying(200) PRIMARY KEY,
    email_add 	character varying(30),
    phone_num 	numeric(10,0),
    bank_acc 	numeric(15,0)
);

CREATE TABLE project.book (
    isbn 		numeric(13,0) PRIMARY KEY,
    name 		character varying(200),
    version 	numeric(2,0),
    num_pages 	numeric(4,0),
    price 		numeric(5,2),
    royalty 	numeric(4,2),
    stock 		integer
);

CREATE TABLE project.basket (
	basket_id 	SERIAL NOT NULL PRIMARY KEY
);

CREATE TABLE project.author (
    auth_fn 	character varying(20) NOT NULL,
    auth_ln 	character varying(40) NOT NULL,

    CONSTRAINT author_pkey PRIMARY KEY (auth_fn, auth_ln)
);

CREATE TABLE project.order (
    order_num 		SERIAL NOT NULL PRIMARY KEY,
    tracking_num 	numeric(16,0),
    date_placed 	timestamp without time zone,
    total_price 	numeric(6,2)
);

CREATE TABLE project.genre (
    name 	character varying(150) PRIMARY KEY
);
-- Relations

CREATE TABLE project.hasAdd (
    user_name 	character varying(16) NOT NULL REFERENCES project.user(user_name),
    add_id 		SERIAL NOT NULL REFERENCES project.address(add_id),
    isshipping 	boolean NOT NULL,
    isbilling 	boolean NOT NULL,

    CONSTRAINT 	hasadd_pkey PRIMARY KEY (user_name, add_id),
    UNIQUE (user_name, isshipping, isbilling)
);

CREATE TABLE project.pubadd (
    add_id 		SERIAL NOT NULL REFERENCES project.address(add_id),
    pub_name 	character varying(200) REFERENCES project.publisher(name) UNIQUE,

    CONSTRAINT 	pubadd_pkey PRIMARY KEY (add_id, pub_name)
);

CREATE TABLE project.publishes (
    pub_name 	character varying(200) REFERENCES project.publisher(name) NOT NULL,
    isbn 		numeric(13,0) REFERENCES project.book(isbn) NOT NULL UNIQUE,
    year 		numeric(4,0),

    CONSTRAINT publishes_pkey PRIMARY KEY (pub_name, isbn)
);

CREATE TABLE project.writes (
    auth_fn character varying(20),
    auth_ln character varying(40),
    isbn 	numeric(13,0) REFERENCES project.book(isbn),

    CONSTRAINT writes_pkey PRIMARY KEY (auth_fn, auth_ln, isbn),
    CONSTRAINT writes_fkey FOREIGN KEY (auth_fn, auth_ln) REFERENCES project.author
);

CREATE TABLE project.bask_item (
    basket_id 	SERIAL NOT NULL REFERENCES project.basket(basket_id),
    isbn 		numeric(13,0) REFERENCES project.book(isbn),
    quantity 	integer,

    CONSTRAINT bask_item_pkey PRIMARY KEY (basket_id, isbn)
);

CREATE TABLE project.bask_manage (
    user_name 	character varying(16) REFERENCES project.user(user_name),
    basket_id 	SERIAL NOT NULL REFERENCES project.basket(basket_id),

    CONSTRAINT bask_manage_pkey PRIMARY KEY (user_name, basket_id)
);

CREATE TABLE project.checkout (
    basket_id 	SERIAL NOT NULL REFERENCES project.basket(basket_id),
    order_num 	SERIAL NOT NULL REFERENCES project.order(order_num),

    CONSTRAINT checkout_pkey PRIMARY KEY (basket_id, order_num)
);

CREATE TABLE project.ordadd (
    order_num 	SERIAL NOT NULL REFERENCES project.order(order_num),
    add_id 		SERIAL NOT NULL REFERENCES project.address(add_id),

    CONSTRAINT	ordadd_pkey PRIMARY KEY (order_num, add_id)

);

CREATE TABLE project.hasgenre (
    name 	character varying(150) REFERENCES project.genre(name),
    isbn	numeric(13,0) REFERENCES project.book(isbn),

    CONSTRAINT	hasgenre_pkey PRIMARY KEY (name, isbn)

);

-- Functions
CREATE FUNCTION delete_old_admin() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    DELETE FROM project.librarian WHERE salary IS NULL;
    RETURN NULL;
END;
$$;;

-- Triggers

CREATE TRIGGER delete_admin
AFTER UPDATE OR INSERT ON project.librarian
FOR EACH ROW
WHEN (new.salary IS NULL)
EXECUTE PROCEDURE delete_old_admin();

